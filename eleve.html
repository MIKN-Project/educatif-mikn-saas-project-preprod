<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Espace √âl√®ve ‚Äî Educatif MIKN</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ===== √âL√àVE ‚Äî styles sp√©cifiques ===== */

    /* Moyenne banner */
    .moyenne-banner {
      background: linear-gradient(135deg, var(--orange), #ea580c);
      color: #fff;
      border-radius: var(--radius);
      padding: 24px 28px;
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(249,115,22,.3);
    }
    .moyenne-value { font-size: 3rem; font-weight: 900; line-height: 1; }
    .moyenne-label { font-size: 14px; opacity: .85; margin-top: 4px; }
    .moyenne-sub   { font-size: 13px; opacity: .7; }

    /* Mati√®res grid */
    .matieres-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(155px, 1fr));
      gap: 12px;
    }
    .matiere-badge {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 12px 14px;
      border-left: 4px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .matiere-badge span  { font-size: 12px; color: var(--text-muted); font-weight: 600;
                           text-transform: uppercase; letter-spacing: .04em; }
    .matiere-badge strong { font-size: 20px; font-weight: 800; }

    /* Barre de progression note */
    .progress-bar-wrap {
      width: 80px; height: 6px;
      background: var(--border); border-radius: 999px;
      overflow: hidden; display: inline-block; vertical-align: middle;
    }
    .progress-bar { height: 100%; border-radius: 999px; transition: width .3s; }

    /* Note row (dashboard) */
    .note-row {
      display: flex; align-items: center;
      justify-content: space-between;
      padding: 10px 0; border-bottom: 1px solid var(--border); gap: 12px;
    }
    .note-row:last-child { border-bottom: none; }
    .note-info  { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
    .note-title { font-weight: 600; font-size: 14px;
                  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .note-score { font-size: 16px; flex-shrink: 0; }

    /* Activity row (dashboard) */
    .activity-row {
      display: flex; align-items: center;
      justify-content: space-between;
      padding: 10px 0; border-bottom: 1px solid var(--border); gap: 12px;
    }
    .activity-row:last-child { border-bottom: none; }

    /* Activity cards */
    .activity-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 18px 20px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
      border-left: 4px solid var(--border);
      transition: border-color .15s;
    }
    .activity-card:hover             { border-left-color: var(--orange); }
    .activity-card.status-submitted  { border-left-color: #16a34a; }
    .activity-card.status-graded     { border-left-color: #7c3aed; }
    .activity-card.status-late       { border-left-color: #dc2626; }
    .activity-card-header {
      display: flex; align-items: flex-start;
      justify-content: space-between; gap: 12px; margin-bottom: 8px;
    }
    .activity-title { font-size: 16px; font-weight: 700; margin: 0 0 4px 0; }
    .activity-desc  { font-size: 13px; color: var(--text-muted); margin: 8px 0; line-height: 1.5; }
    .activity-footer {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; flex-wrap: wrap;
      margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);
    }
    .due-date         { font-size: 13px; color: var(--text-muted); }
    .due-date.overdue { color: #dc2626; font-weight: 600; }
    .teacher-comment  {
      font-size: 13px; color: #1d4ed8;
      background: #dbeafe; padding: 6px 10px;
      border-radius: 8px; margin-top: 8px; width: 100%;
    }

    /* Badges */
    .badge {
      display: inline-flex; align-items: center; gap: 4px;
      border-radius: 999px; padding: 3px 12px;
      font-size: 12px; font-weight: 600; white-space: nowrap;
    }
    .badge-info    { background: #dbeafe; color: #1e40af; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-success { background: #d1fae5; color: #065f46; }
    .badge-error   { background: #fee2e2; color: #991b1b; }
    .badge-purple  { background: #ede9fe; color: #5b21b6; }

    /* Tags */
    .tag      { display: inline-block; background: var(--border); color: var(--text-muted);
                border-radius: 6px; padding: 2px 8px; font-size: 12px; font-weight: 600; }
    .tag-type { background: #ede9fe; color: #7c3aed; }

    /* Filter tabs */
    .filter-tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
    .filter-tab  {
      padding: 6px 16px; border-radius: 999px;
      border: 1.5px solid var(--border); background: transparent;
      font-size: 13px; font-weight: 600; color: var(--text-muted);
      cursor: pointer; transition: all .12s;
    }
    .filter-tab.active,
    .filter-tab:hover { background: var(--orange); color: #fff; border-color: var(--orange); }

    /* Quiz cards */
    .quiz-card {
      background: var(--bg-card); border-radius: var(--radius);
      padding: 18px 20px; box-shadow: var(--shadow); margin-bottom: 14px;
    }
    .quiz-card-header {
      display: flex; align-items: flex-start;
      justify-content: space-between; gap: 12px; margin-bottom: 10px;
    }
    .quiz-meta { display: flex; gap: 14px; font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }

    /* ===== QUIZ PLAYER ===== */
    .modal-quiz-full .modal-content { max-width: 700px; }
    .quiz-timer {
      display: inline-flex; align-items: center; gap: 8px;
      background: #fef3c7; border-radius: 999px;
      padding: 5px 14px; font-size: 14px; font-weight: 700; color: #92400e;
    }
    .quiz-timer.danger { background: #fee2e2; color: #991b1b; }
    .quiz-progress-bar-wrap {
      background: var(--border); border-radius: 999px;
      height: 4px; margin: 0 24px 16px; overflow: hidden;
    }
    .quiz-question {
      background: var(--bg-main); border-radius: 12px;
      padding: 18px; margin-bottom: 14px;
      border: 1px solid var(--border);
    }
    [data-theme="dark"] .quiz-question { background: #0f172a; }
    .quiz-question-header {
      display: flex; align-items: center;
      justify-content: space-between; margin-bottom: 10px;
    }
    .quiz-q-num  {
      font-size: 11px; text-transform: uppercase;
      font-weight: 700; color: var(--text-muted); letter-spacing: .06em;
    }
    .quiz-q-text { font-size: 15px; font-weight: 600; margin-bottom: 14px; }
    .quiz-options { display: flex; flex-direction: column; gap: 8px; }
    .quiz-option {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px; border-radius: 10px;
      border: 1.5px solid var(--border); cursor: pointer;
      transition: all .12s; font-size: 14px;
    }
    .quiz-option:hover    { border-color: var(--orange); background: #fff7ed; }
    .quiz-option.selected { border-color: var(--orange); background: #fff7ed; font-weight: 600; }
    [data-theme="dark"] .quiz-option.selected { background: #1c0f00; }
    .quiz-option input[type="radio"] {
      accent-color: var(--orange); width: 16px; height: 16px; flex-shrink: 0;
    }

    /* ===== R√âSULTAT QUIZ ===== */
    .quiz-result-score  { text-align: center; padding: 20px 0; }
    .quiz-result-detail { display: flex; flex-direction: column; gap: 8px; }
    .quiz-result-row    { padding: 10px 14px; border-radius: 10px; font-size: 13px; }
    .quiz-result-row.correct { background: #d1fae5; color: #065f46; }
    .quiz-result-row.wrong   { background: #fee2e2; color: #991b1b; }
    .quiz-result-row.open    { background: #fef3c7; color: #92400e; }
    .quiz-result-row small   { display: block; margin-top: 3px; font-style: italic; }

    /* ===== MESSAGES ===== */
    .msg-thread    { display: flex; flex-direction: column; gap: 12px; }
    .msg-bubble    { max-width: 80%; padding: 10px 14px; border-radius: 14px; font-size: 14px; line-height: 1.5; }
    .msg-bubble.sent     { align-self: flex-end; background: var(--orange); color: #fff; border-bottom-right-radius: 4px; }
    .msg-bubble.received { align-self: flex-start; background: var(--bg-card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
    .msg-meta      { font-size: 11px; opacity: .7; margin-top: 4px; }
    .msg-input-row { display: flex; gap: 10px; margin-top: 14px; }

    /* ===== MISC ===== */
    .empty  { text-align: center; color: var(--text-muted); padding: 40px 0; font-size: 14px; }
    .btn-sm { padding: 6px 14px !important; font-size: 13px !important; }
    .file-label {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px; border-radius: 10px;
      border: 1.5px dashed var(--border); cursor: pointer;
      font-size: 13px; color: var(--text-muted); transition: border-color .12s;
    }
    .file-label:hover { border-color: var(--orange); color: var(--orange); }
    .file-label input { display: none; }
    .submission-preview { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }

    @media (max-width: 768px) {
      .cards { grid-template-columns: repeat(2, 1fr) !important; }
      .matieres-grid { grid-template-columns: repeat(2, 1fr); }
      .moyenne-banner { flex-direction: column; gap: 10px; text-align: center; }
      .moyenne-value  { font-size: 2.2rem; }
    }
  </style>
</head>
<body>

<!-- ========== TOAST ========== -->
<div id="toast" class="toast" role="alert">
  <strong id="toastTitle"></strong>
  <p id="toastMsg"></p>
</div>

<!-- ========== HEADER ========== -->
<header class="header">
  <div class="header-title">
    <h1 id="pageTitle">Tableau de bord</h1>
    <p id="pageSubtitle">Vue rapide</p>
  </div>
  <div class="header-actions">
    <span class="header-user">üéí <span id="who">Chargement‚Ä¶</span></span>
    <span id="className" class="tag" style="font-size:13px;"></span>
    <button id="themeBtn" class="btn-icon" title="Th√®me">üåô</button>
    <button id="logoutBtn" class="btn btn-secondary btn-sm">D√©connexion</button>
  </div>
</header>

<!-- ========== LAYOUT ========== -->
<div class="layout">

  <!-- ---- SIDEBAR ---- -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">M</div>
      <div>
        <div class="sidebar-title">Educatif MIKN</div>
        <div class="sidebar-subtitle">Espace √âl√®ve</div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">Navigation</div>

      <a href="#" class="nav-item active" data-view="dashboard">
        <span class="nav-icon">üè†</span> Tableau de bord
      </a>
      <a href="#" class="nav-item" data-view="notes">
        <span class="nav-icon">üìä</span> Mes notes
      </a>
      <a href="#" class="nav-item" data-view="activites">
        <span class="nav-icon">üìù</span> Mes activit√©s
        <span id="badgeActivites" class="nav-badge" style="display:none;">0</span>
      </a>
      <a href="#" class="nav-item" data-view="quiz">
        <span class="nav-icon">üéØ</span> Quiz
        <span id="badgeQuiz" class="nav-badge" style="display:none;">0</span>
      </a>
      <a href="#" class="nav-item" data-view="messages">
        <span class="nav-icon">‚úâÔ∏è</span> Messages
        <span id="badgeMessages" class="nav-badge" style="display:none;">0</span>
      </a>
    </nav>
  </aside>

  <!-- ---- MAIN CONTENT ---- -->
  <main class="main-content">

    <!-- ============================================================
         VUE DASHBOARD
    ============================================================ -->
    <section id="view-dashboard" class="view active">

      <div class="cards" style="grid-template-columns:repeat(4,minmax(0,1fr));">
        <div class="card">
          <div class="card-icon card-icon-yellow">üìä</div>
          <div>
            <div class="card-value" id="stat-moyenne">‚Äî</div>
            <div class="card-label">Moyenne g√©n√©rale</div>
          </div>
        </div>
        <div class="card">
          <div class="card-icon card-icon-blue">üìù</div>
          <div>
            <div class="card-value" id="stat-pending">0</div>
            <div class="card-label">Activit√©s en attente</div>
          </div>
        </div>
        <div class="card">
          <div class="card-icon card-icon-green">üéØ</div>
          <div>
            <div class="card-value" id="stat-quiz">0</div>
            <div class="card-label">Quiz disponibles</div>
          </div>
        </div>
        <div class="card">
          <div class="card-icon" style="background:#fce7f3;">‚úâÔ∏è</div>
          <div>
            <div class="card-value" id="stat-messages">0</div>
            <div class="card-label">Messages non lus</div>
          </div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="panel">
          <div class="panel-header">
            <h2>üìä Derni√®res notes</h2>
            <button class="btn btn-secondary btn-sm" onclick="switchStudentView('notes')">Voir tout ‚Üí</button>
          </div>
          <div id="dashRecentNotes">
            <p class="panel-empty">Aucune note disponible.</p>
          </div>
        </div>
        <div class="panel">
          <div class="panel-header">
            <h2>‚è∞ √Ä rendre bient√¥t</h2>
            <button class="btn btn-secondary btn-sm" onclick="switchStudentView('activites')">Voir tout ‚Üí</button>
          </div>
          <div id="dashUrgentActivities">
            <p class="panel-empty">Aucune activit√© en attente.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================================================
         VUE NOTES
    ============================================================ -->
    <section id="view-notes" class="view">

      <div class="moyenne-banner">
        <div>
          <div class="moyenne-value" id="globalMoyenne">‚Äî</div>
          <div class="moyenne-label">Moyenne g√©n√©rale /20</div>
          <div class="moyenne-sub" id="noteCount">0 note(s) enregistr√©e(s)</div>
        </div>
        <div style="flex:1;"></div>
        <div style="text-align:right;">
          <div style="font-size:13px;opacity:.8;">üìÖ Derni√®re note</div>
          <div id="lastNoteDate" style="font-weight:700;font-size:15px;">‚Äî</div>
        </div>
      </div>

      <div class="panel" style="margin-bottom:20px;">
        <div class="panel-header"><h2>üìö Par mati√®re</h2></div>
        <div id="matieresContainer" class="matieres-grid">
          <p class="panel-empty">Aucune donn√©e.</p>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header"><h2>üìã Toutes mes notes</h2></div>
        <div class="table-wrap" id="notesContainer">
          <p class="panel-empty">Chargement‚Ä¶</p>
        </div>
      </div>

    </section>

    <!-- ============================================================
         VUE ACTIVIT√âS
    ============================================================ -->
    <section id="view-activites" class="view">

      <div class="panel-header" style="margin-bottom:0;">
        <h2>üìù Mes activit√©s</h2>
      </div>

      <div class="filter-tabs" style="margin-top:16px;">
        <button class="filter-tab active" onclick="filterActivites(this,'all')">Toutes</button>
        <button class="filter-tab" onclick="filterActivites(this,'assigned')">üì§ Assign√©es</button>
        <button class="filter-tab" onclick="filterActivites(this,'in_progress')">‚è≥ En cours</button>
        <button class="filter-tab" onclick="filterActivites(this,'submitted')">‚úÖ Rendues</button>
        <button class="filter-tab" onclick="filterActivites(this,'graded')">üéØ Corrig√©es</button>
        <button class="filter-tab" onclick="filterActivites(this,'late')">‚ö†Ô∏è En retard</button>
      </div>

      <div id="activitesContainer">
        <p class="empty">Chargement‚Ä¶</p>
      </div>
    </section>

    <!-- ============================================================
         VUE QUIZ
    ============================================================ -->
    <section id="view-quiz" class="view">

      <div class="panel-header" style="margin-bottom:16px;">
        <h2>üéØ Mes quiz</h2>
      </div>

      <div id="quizContainer">
        <p class="empty">Chargement‚Ä¶</p>
      </div>
    </section>

    <!-- ============================================================
         VUE MESSAGES
    ============================================================ -->
    <section id="view-messages" class="view">
      <div class="panel">
        <div class="panel-header">
          <h2>‚úâÔ∏è Messages</h2>
        </div>
        <div id="msgThread" class="msg-thread"
             style="min-height:200px;max-height:420px;overflow-y:auto;padding:4px 0;">
          <p class="empty">Aucun message.</p>
        </div>
        <div class="msg-input-row">
          <input id="msgInput" class="input" type="text"
                 placeholder="√âcrire un message au professeur‚Ä¶"
                 style="flex:1;"
                 onkeydown="if(event.key==='Enter') sendStudentMessage()">
          <button class="btn" onclick="sendStudentMessage()">Envoyer ‚Üí</button>
        </div>
      </div>
    </section>

  </main>
</div><!-- /.layout -->


<!-- ============================================================
     MODAL ‚Äî RENDRE UN DEVOIR
============================================================ -->
<div id="modalSubmission" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üì§ Rendre le devoir</h2>
      <button class="modal-close"
        onclick="document.getElementById('modalSubmission').classList.remove('show')">‚úï</button>
    </div>
    <div class="modal-body">

      <div style="background:var(--bg-main);border-radius:10px;
                  padding:12px 14px;border:1px solid var(--border);">
        <div style="font-size:11px;color:var(--text-muted);
                    text-transform:uppercase;font-weight:700;letter-spacing:.05em;">
          Activit√©
        </div>
        <div id="submissionTitle" style="font-weight:700;font-size:15px;margin-top:4px;"></div>
        <div id="submissionDue"   style="font-size:13px;color:var(--text-muted);margin-top:2px;"></div>
      </div>

      <div id="submissionExisting"
           style="display:none;background:#d1fae5;border-radius:10px;
                  padding:10px 14px;font-size:13px;color:#065f46;">
        ‚úÖ Tu as d√©j√† rendu ce devoir. Tu peux modifier ta r√©ponse avant la date limite.
      </div>

      <div class="form-group">
        <label style="display:block;font-size:12px;font-weight:700;
                      text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">
          R√©ponse √©crite
        </label>
        <textarea id="submissionText" class="input" rows="5"
                  placeholder="√âcris ta r√©ponse ici‚Ä¶"></textarea>
      </div>

      <div>
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;
                    color:var(--text-muted);margin-bottom:8px;">
          Ou joindre un fichier
        </div>
        <label class="file-label">
          üìé Choisir un fichier (PDF, image, doc‚Ä¶)
          <input type="file" id="submissionFile"
                 accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.txt,.zip"
                 onchange="previewSubmissionFile(this)">
        </label>
        <div id="submissionPreview" class="submission-preview"></div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary"
        onclick="document.getElementById('modalSubmission').classList.remove('show')">
        Annuler
      </button>
      <button id="btnSubmitDevoir" class="btn" onclick="submitDevoir()">
        Rendre le devoir ‚úì
      </button>
    </div>
  </div>
</div>


<!-- ============================================================
     MODAL ‚Äî QUIZ PLAYER
============================================================ -->
<div id="modalQuiz" class="modal modal-quiz-full">
  <div class="modal-content" style="max-width:700px;">

    <div class="modal-header">
      <div>
        <h2 id="quizPlayerTitle">Quiz</h2>
        <div style="display:flex;align-items:center;gap:12px;margin-top:6px;">
          <span id="quizProgress" style="font-size:13px;color:var(--text-muted);"></span>
          <div id="quizTimer" class="quiz-timer" style="display:none;">
            ‚è±Ô∏è <span id="quizTimerDisplay">00:00</span>
          </div>
        </div>
      </div>
      <button class="modal-close" id="quizCloseBtn">‚úï</button>
    </div>

    <!-- Barre de progression -->
    <div class="quiz-progress-bar-wrap">
      <div id="quizProgressBar" class="progress-bar"
           style="width:0%;background:var(--orange);"></div>
    </div>

    <div class="modal-body" id="quizQuestionsContainer" style="max-height:62vh;">
      <!-- Questions g√©n√©r√©es dynamiquement -->
    </div>

    <div class="modal-footer" style="justify-content:space-between;">
      <button class="btn btn-secondary" id="quizCancelBtn">Abandonner</button>
      <button id="btnSubmitQuiz" class="btn">Soumettre le quiz ‚Üí</button>
    </div>
  </div>
</div>


<!-- ============================================================
     MODAL ‚Äî R√âSULTAT QUIZ
============================================================ -->
<div id="modalQuizResult" class="modal">
  <div class="modal-content" style="max-width:560px;">
    <div class="modal-header">
      <h2>üèÜ R√©sultat du quiz</h2>
      <button class="modal-close"
        onclick="document.getElementById('modalQuizResult').classList.remove('show')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="quizResultScore" class="quiz-result-score"></div>
      <hr style="border:none;border-top:1px solid var(--border);margin:4px 0 12px;">
      <div style="font-size:12px;font-weight:700;text-transform:uppercase;
                  color:var(--text-muted);margin-bottom:10px;">
        D√©tail des r√©ponses
      </div>
      <div id="quizResultDetail" class="quiz-result-detail"></div>
    </div>
    <div class="modal-footer">
      <button class="btn"
        onclick="document.getElementById('modalQuizResult').classList.remove('show')">
        Fermer
      </button>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="app.js"></script>
<script>initStudent();</script>

</body>
</html>
