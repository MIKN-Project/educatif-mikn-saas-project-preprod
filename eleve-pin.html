<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connexion Ã‰lÃ¨ve â€” Educatif MIKN</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .pin-page{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg-main);padding:20px}
    .pin-card{background:var(--bg-card);border-radius:20px;padding:40px 36px;max-width:420px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,.12);border:1px solid var(--border)}
    .pin-logo{width:60px;height:60px;background:var(--orange);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:30px;margin:0 auto 20px;color:#fff;font-weight:900}
    .pin-input{font-size:30px!important;letter-spacing:10px!important;text-align:center!important;font-weight:900!important;padding:16px!important}
  </style>
</head>
<body>
  <div id="toast" class="toast"><strong id="toastTitle"></strong><p id="toastMsg"></p></div>

  <div class="pin-page">
    <div class="pin-card">
      <div class="pin-logo">M</div>
      <h1 style="text-align:center;font-size:22px;margin-bottom:6px">Connexion Ã‰lÃ¨ve</h1>
      <p style="text-align:center;color:var(--text-muted);font-size:14px;margin-bottom:28px">
        Entre ton code de classe et ton PIN personnel
      </p>

      <div class="form-group">
        <label>ğŸ« Code de classe</label>
        <input type="text" id="classCode" class="input"
          placeholder="Ex : CM2A07" maxlength="10"
          style="text-transform:uppercase;font-weight:700;letter-spacing:3px;text-align:center;font-size:18px"
          oninput="this.value=this.value.toUpperCase()"
          onkeydown="if(event.key==='Enter') document.getElementById('pinCode').focus()">
        <div style="font-size:12px;color:var(--text-muted);margin-top:4px;text-align:center">
          Demande ce code Ã  ton professeur
        </div>
      </div>

      <div class="form-group">
        <label>ğŸ”‘ Ton code PIN</label>
        <input type="text" id="pinCode" class="input pin-input"
          placeholder="â€¢â€¢â€¢â€¢" maxlength="6" inputmode="numeric"
          onkeydown="if(event.key==='Enter') loginEleve()">
      </div>

      <button class="btn" id="btnLogin" onclick="loginEleve()"
        style="width:100%;padding:14px;font-size:16px;margin-top:8px">
        ğŸš€ Me connecter
      </button>

      <div style="margin-top:20px;text-align:center;font-size:12px;color:var(--text-muted)">
        Pas de code ? Demande Ã  ton professeur d'activer<br>ton accÃ¨s PIN dans ta fiche Ã©lÃ¨ve.
      </div>
    </div>
  </div>

  <script>
    // ThÃ¨me
    document.documentElement.dataset.theme = localStorage.getItem('mcv_theme') || 'light';

    // DÃ©jÃ  connectÃ© â†’ redirige directement
    try {
      const _e = localStorage.getItem('mcv_eleve');
      if (_e && JSON.parse(_e)?.id) location.href = 'eleve.html';
    } catch(e) { localStorage.removeItem('mcv_eleve'); }

    // Toast
    function toast(title, msg, type='info') {
      const t = document.getElementById('toast'); if(!t) return;
      document.getElementById('toastTitle').textContent = title;
      document.getElementById('toastMsg').textContent   = msg;
      t.className = 'toast show' + (type==='error' ? ' toast-error' : type==='success' ? ' toast-success' : '');
      clearTimeout(window.__t); window.__t = setTimeout(() => t.classList.remove('show'), 3500);
    }

    const SUPA_URL = "https://itmvhjdblohqrgrbtaap.supabase.co";
    const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0bXZoamRibG9ocXJncmJ0YWFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMTMzOTcsImV4cCI6MjA4Njg4OTM5N30.Sx5e6YQwWtTiNR29-9kKfOorMKquj5dcIJN4VO4JSao";

    async function loginEleve() {
      const classCode = document.getElementById('classCode').value.trim().toUpperCase();
      const pinCode   = document.getElementById('pinCode').value.trim();
      const btn       = document.getElementById('btnLogin');

      if (!classCode) { toast('Requis', 'Entre ton code de classe.', 'error'); return; }
      if (!pinCode)   { toast('Requis', 'Entre ton PIN.', 'error'); return; }

      btn.disabled = true; btn.textContent = 'â³ Connexionâ€¦';

      try {
        const db = window.supabase.createClient(SUPA_URL, SUPA_KEY);

        // Ã‰tape 1 â€” Trouver la classe via son code
        const { data: cls, error: clsErr } = await db
          .from('classes')
          .select('id, name, teacher_id')
          .eq('class_code', classCode)
          .maybeSingle();

        if (clsErr || !cls) {
          toast('Code invalide', 'Ce code de classe est introuvable.', 'error');
          btn.disabled = false; btn.textContent = 'ğŸš€ Me connecter'; return;
        }

        // Ã‰tape 2 â€” VÃ©rifier le PIN dans cette classe
        const { data: stu, error: stuErr } = await db
          .from('students')
          .select('id, first_name, last_name, class_id, teacher_id')
          .eq('class_id', cls.id)
          .eq('pin_code', pinCode)
          .eq('pin_enabled', true)
          .maybeSingle();

        if (stuErr || !stu) {
          toast('PIN incorrect', 'Code PIN invalide ou accÃ¨s non activÃ©.', 'error');
          btn.disabled = false; btn.textContent = 'ğŸš€ Me connecter'; return;
        }

        // âœ… Connexion rÃ©ussie
        localStorage.setItem('mcv_eleve', JSON.stringify({
          id:         stu.id,
          first_name: stu.first_name,
          last_name:  stu.last_name,
          class_id:   stu.class_id,
          class_name: cls.name,
          teacher_id: stu.teacher_id
        }));

        toast('Bienvenue !', `Bonjour ${stu.first_name} ğŸ‘‹`, 'success');
        setTimeout(() => location.href = 'eleve.html', 900);

      } catch(e) {
        toast('Erreur', e.message || String(e), 'error');
        btn.disabled = false; btn.textContent = 'ğŸš€ Me connecter';
      }
    }
  </script>
</body>
</html>
